name: MP3
endianness: big
root: mp3

enums:
  mpeg_version:
    - value: 0
      label: MPEG2.5
    - value: 2
      label: MPEG2
    - value: 3
      label: MPEG1

  mpeg_layer:
    - value: 1
      label: Layer_III
    - value: 2
      label: Layer_II
    - value: 3
      label: Layer_I

  mp3_bitrate:
    - value: 1
      label: 32kbps
    - value: 2
      label: 40kbps
    - value: 3
      label: 48kbps
    - value: 4
      label: 56kbps
    - value: 5
      label: 64kbps
    - value: 6
      label: 80kbps
    - value: 7
      label: 96kbps
    - value: 8
      label: 112kbps
    - value: 9
      label: 128kbps
    - value: 10
      label: 160kbps
    - value: 11
      label: 192kbps
    - value: 12
      label: 224kbps
    - value: 13
      label: 256kbps
    - value: 14
      label: 320kbps

  mp3_sample_rate:
    - value: 0
      label: 44100Hz
    - value: 1
      label: 48000Hz
    - value: 2
      label: 32000Hz

  channel_mode:
    - value: 0
      label: stereo
    - value: 1
      label: joint_stereo
    - value: 2
      label: dual_channel
    - value: 3
      label: mono

structs:
  mp3:
    - name: id3v2_header
      type: struct
      struct: id3v2_header
    - name: id3v2_body
      type: switch
      size: "{tag_size}"
      switch_on: "1"
      cases:
        "1": id3v2_frames
      description: "ID3v2タグ本体（フレーム群）"
    - name: mpeg_frame_header
      type: struct
      struct: mpeg_frame_header
    - name: audio_properties
      type: struct
      struct: audio_properties
    - name: channel_mode_and_extension
      type: struct
      struct: channel_mode_and_extension

  id3v2_header:
    - name: magic
      type: ascii
      size: "3"
      description: "ID3"
    - name: version
      type: uint8
      description: "ID3v2バージョン（3=v2.3, 4=v2.4）"
    - name: revision
      type: uint8
    - name: flags
      type: bitfield
      size: "1"
      fields:
        - name: unsynchronisation
          bits: "7"
        - name: extended_header
          bits: "6"
        - name: experimental
          bits: "5"
        - name: footer
          bits: "4"
    - name: size_b0
      type: uint8
    - name: size_b1
      type: uint8
    - name: size_b2
      type: uint8
    - name: size_b3
      type: uint8
    - name: tag_size
      type: virtual
      value: "{(size_b0 << 21) | (size_b1 << 14) | (size_b2 << 7) | size_b3}"
      description: "シンクセーフ整数から算出したタグサイズ"

  id3v2_frames:
    - name: frames
      type: struct
      struct: id3v2_frame
      repeat: eof

  id3v2_frame:
    - name: frame_id
      type: ascii
      size: "4"
      description: "フレーム識別子（TIT2, TPE1, TALB等）"
    - name: frame_size
      type: uint32
      description: "フレームデータサイズ"
    - name: frame_flags
      type: uint16
      description: "フレームフラグ"
    - name: frame_data
      type: bytes
      size: "{frame_size}"
      description: "フレームデータ本体"

  mpeg_frame_header:
    - name: raw
      type: uint16
      description: "MPEGフレームヘッダ前半2バイト"
    - name: sync
      type: virtual
      value: "{raw >> 5}"
      description: "同期ワード（0x7FF）"
    - name: mpeg_version
      type: virtual
      value: "{(raw >> 3) & 3}"
      description: "MPEGバージョン（0=MPEG2.5, 2=MPEG2, 3=MPEG1）"
    - name: layer
      type: virtual
      value: "{(raw >> 1) & 3}"
      description: "レイヤー（1=Layer III, 2=Layer II, 3=Layer I）"
    - name: protection
      type: virtual
      value: "{raw & 1}"
      description: "CRC保護（0=あり, 1=なし）"

  audio_properties:
    - name: raw
      type: uint8
      description: "オーディオプロパティバイト"
    - name: bitrate_index
      type: virtual
      value: "{raw >> 4}"
      description: "ビットレートインデックス"
    - name: sample_rate_index
      type: virtual
      value: "{(raw >> 2) & 3}"
      description: "サンプリングレートインデックス"
    - name: padding
      type: virtual
      value: "{(raw >> 1) & 1}"
      description: "パディングビット"
    - name: private
      type: virtual
      value: "{raw & 1}"
      description: "プライベートビット"

  channel_mode_and_extension:
    - name: raw
      type: uint8
      description: "チャンネルモード・拡張バイト"
    - name: channel_mode
      type: virtual
      value: "{raw >> 6}"
      description: "チャンネルモード（0=ステレオ, 1=ジョイントステレオ, 2=デュアルチャンネル, 3=モノラル）"
    - name: mode_extension
      type: virtual
      value: "{(raw >> 4) & 3}"
      description: "モード拡張（ジョイントステレオ時のみ有効）"
    - name: copyright
      type: virtual
      value: "{(raw >> 3) & 1}"
      description: "コピーライトフラグ"
    - name: original
      type: virtual
      value: "{(raw >> 2) & 1}"
      description: "オリジナルフラグ"
    - name: emphasis
      type: virtual
      value: "{raw & 3}"
      description: "エンファシス（0=なし, 1=50/15ms, 2=reserved, 3=CCITT J.17）"
