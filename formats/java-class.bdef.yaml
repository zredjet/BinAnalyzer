name: JavaClass
endianness: big
root: java_class

enums:
  java_version:
    - value: 45
      label: Java_1_1
    - value: 46
      label: Java_1_2
    - value: 47
      label: Java_1_3
    - value: 48
      label: Java_1_4
    - value: 49
      label: Java_5
    - value: 50
      label: Java_6
    - value: 51
      label: Java_7
    - value: 52
      label: Java_8
    - value: 53
      label: Java_9
    - value: 54
      label: Java_10
    - value: 55
      label: Java_11
    - value: 56
      label: Java_12
    - value: 57
      label: Java_13
    - value: 58
      label: Java_14
    - value: 59
      label: Java_15
    - value: 60
      label: Java_16
    - value: 61
      label: Java_17
    - value: 62
      label: Java_18
    - value: 63
      label: Java_19
    - value: 64
      label: Java_20
    - value: 65
      label: Java_21
    - value: 66
      label: Java_22
    - value: 67
      label: Java_23

  cp_tag:
    - value: 1
      label: Utf8
    - value: 3
      label: Integer
    - value: 4
      label: Float
    - value: 5
      label: Long
    - value: 6
      label: Double
    - value: 7
      label: Class
    - value: 8
      label: String
    - value: 9
      label: Fieldref
    - value: 10
      label: Methodref
    - value: 11
      label: InterfaceMethodref
    - value: 12
      label: NameAndType
    - value: 15
      label: MethodHandle
    - value: 16
      label: MethodType
    - value: 17
      label: Dynamic
    - value: 18
      label: InvokeDynamic
    - value: 19
      label: Module
    - value: 20
      label: Package

flags:
  class_access_flags:
    bit_size: 16
    fields:
      - name: ACC_PUBLIC
        bit: 0
        set: "public"
        clear: ""
      - name: ACC_FINAL
        bit: 4
        set: "final"
        clear: ""
      - name: ACC_SUPER
        bit: 5
        set: "super"
        clear: ""
      - name: ACC_INTERFACE
        bit: 9
        set: "interface"
        clear: ""
      - name: ACC_ABSTRACT
        bit: 10
        set: "abstract"
        clear: ""
      - name: ACC_SYNTHETIC
        bit: 12
        set: "synthetic"
        clear: ""
      - name: ACC_ANNOTATION
        bit: 13
        set: "annotation"
        clear: ""
      - name: ACC_ENUM
        bit: 14
        set: "enum"
        clear: ""

  member_access_flags:
    bit_size: 16
    fields:
      - name: ACC_PUBLIC
        bit: 0
        set: "public"
        clear: ""
      - name: ACC_PRIVATE
        bit: 1
        set: "private"
        clear: ""
      - name: ACC_PROTECTED
        bit: 2
        set: "protected"
        clear: ""
      - name: ACC_STATIC
        bit: 3
        set: "static"
        clear: ""
      - name: ACC_FINAL
        bit: 4
        set: "final"
        clear: ""
      - name: ACC_SYNCHRONIZED
        bit: 5
        set: "synchronized"
        clear: ""
      - name: ACC_BRIDGE
        bit: 6
        set: "bridge"
        clear: ""
      - name: ACC_VARARGS
        bit: 7
        set: "varargs"
        clear: ""
      - name: ACC_NATIVE
        bit: 8
        set: "native"
        clear: ""
      - name: ACC_ABSTRACT
        bit: 10
        set: "abstract"
        clear: ""

structs:
  java_class:
    - name: magic
      type: bytes
      size: "4"
      expected: [0xCA, 0xFE, 0xBA, 0xBE]
      description: "Javaクラスファイルマジック（0xCAFEBABE）"
    - name: minor_version
      type: uint16
    - name: major_version
      type: uint16
      enum: java_version
    - name: constant_pool_count
      type: uint16
    - name: constant_pool
      type: struct
      struct: cp_entry
      repeat_count: "{constant_pool_count - 1}"
      description: "コンスタントプール（count - 1エントリ。Long/Doubleは2スロット占有 - 既知の制限事項）"
    - name: access_flags
      type: uint16
      flags: class_access_flags
    - name: this_class
      type: uint16
      description: "このクラスのコンスタントプールインデックス"
    - name: super_class
      type: uint16
      description: "スーパークラスのコンスタントプールインデックス"
    - name: interfaces_count
      type: uint16
    - name: interfaces
      type: uint16
      repeat_count: "{interfaces_count}"
      description: "インタフェースのコンスタントプールインデックス"
    - name: fields_count
      type: uint16
    - name: fields
      type: struct
      struct: member_info
      repeat_count: "{fields_count}"
    - name: methods_count
      type: uint16
    - name: methods
      type: struct
      struct: member_info
      repeat_count: "{methods_count}"
    - name: attributes_count
      type: uint16
    - name: attributes
      type: struct
      struct: attribute_info
      repeat_count: "{attributes_count}"

  cp_entry:
    - name: tag
      type: uint8
      enum: cp_tag
    - name: info
      type: switch
      switch_on: "{tag}"
      cases:
        "1": cp_utf8
        "3": cp_integer
        "4": cp_float
        "5": cp_long
        "6": cp_double
        "7": cp_class
        "8": cp_string
        "9": cp_fieldref
        "10": cp_methodref
        "11": cp_interface_methodref
        "12": cp_name_and_type
        "15": cp_method_handle
        "16": cp_method_type
        "17": cp_dynamic
        "18": cp_invoke_dynamic
        "19": cp_module
        "20": cp_package
      default: raw_data

  cp_utf8:
    - name: length
      type: uint16
    - name: value
      type: bytes
      size: "{length}"
      description: "UTF-8エンコード文字列バイト列"

  cp_integer:
    - name: value
      type: int32

  cp_float:
    - name: value
      type: float32

  cp_long:
    - name: value
      type: int64
      description: "Long値（コンスタントプール2スロット占有）"

  cp_double:
    - name: value
      type: float64
      description: "Double値（コンスタントプール2スロット占有）"

  cp_class:
    - name: name_index
      type: uint16
      description: "クラス名のコンスタントプールインデックス（CONSTANT_Utf8）"

  cp_string:
    - name: string_index
      type: uint16
      description: "文字列値のコンスタントプールインデックス（CONSTANT_Utf8）"

  cp_fieldref:
    - name: class_index
      type: uint16
      description: "クラスのコンスタントプールインデックス（CONSTANT_Class）"
    - name: name_and_type_index
      type: uint16
      description: "名前と型のコンスタントプールインデックス（CONSTANT_NameAndType）"

  cp_methodref:
    - name: class_index
      type: uint16
    - name: name_and_type_index
      type: uint16

  cp_interface_methodref:
    - name: class_index
      type: uint16
    - name: name_and_type_index
      type: uint16

  cp_name_and_type:
    - name: name_index
      type: uint16
      description: "フィールド/メソッド名のコンスタントプールインデックス"
    - name: descriptor_index
      type: uint16
      description: "フィールド/メソッドディスクリプタのコンスタントプールインデックス"

  cp_method_handle:
    - name: reference_kind
      type: uint8
      description: "参照種別（1-9）"
    - name: reference_index
      type: uint16

  cp_method_type:
    - name: descriptor_index
      type: uint16

  cp_invoke_dynamic:
    - name: bootstrap_method_attr_index
      type: uint16
      description: "BootstrapMethods属性のbootstrap_methods配列へのインデックス"
    - name: name_and_type_index
      type: uint16

  cp_dynamic:
    - name: bootstrap_method_attr_index
      type: uint16
      description: "BootstrapMethods属性のbootstrap_methods配列へのインデックス"
    - name: name_and_type_index
      type: uint16
      description: "名前と型のコンスタントプールインデックス（CONSTANT_NameAndType）"

  cp_module:
    - name: name_index
      type: uint16
      description: "モジュール名のコンスタントプールインデックス（CONSTANT_Utf8）"

  cp_package:
    - name: name_index
      type: uint16
      description: "パッケージ名のコンスタントプールインデックス（CONSTANT_Utf8）"

  member_info:
    - name: access_flags
      type: uint16
      flags: member_access_flags
    - name: name_index
      type: uint16
      description: "メンバー名のコンスタントプールインデックス"
    - name: descriptor_index
      type: uint16
      description: "メンバーディスクリプタのコンスタントプールインデックス"
    - name: attributes_count
      type: uint16
    - name: attributes
      type: struct
      struct: attribute_info
      repeat_count: "{attributes_count}"

  attribute_info:
    - name: attribute_name_index
      type: uint16
      description: "属性名のコンスタントプールインデックス（CONSTANT_Utf8）。attribute_name_indexが指すcp_utf8エントリの文字列値によりinfoの内部構造が決まる: 'Code' → code_attribute_body, 'ConstantValue' → constantvalue_attribute_body, 'Exceptions' → exceptions_attribute_body等"
    - name: attribute_length
      type: uint32
    - name: info
      type: bytes
      size: "{attribute_length}"
      description: "属性データ（生バイト列）。内部構造はattribute_name_indexで解決される属性名に依存する。Code: [max_stack:u16, max_locals:u16, code_length:u32, code:bytes[code_length], exception_table_length:u16, exception_table:exception_entry[exception_table_length], attributes_count:u16, attributes:attribute_info[attributes_count]]。ConstantValue: [constantvalue_index:u16]。Exceptions: [number_of_exceptions:u16, exception_index_table:u16[number_of_exceptions]]"

  code_attribute_body:
    - name: max_stack
      type: uint16
      description: "オペランドスタックの最大深度"
    - name: max_locals
      type: uint16
      description: "ローカル変数数（パラメータを含む）"
    - name: code_length
      type: uint32
    - name: code
      type: bytes
      size: "{code_length}"
      description: "バイトコード命令"
    - name: exception_table_length
      type: uint16
    - name: exception_table
      type: struct
      struct: exception_entry
      repeat_count: "{exception_table_length}"
    - name: attributes_count
      type: uint16
    - name: attributes
      type: struct
      struct: attribute_info
      repeat_count: "{attributes_count}"
      description: "Codeサブ属性（例: LineNumberTable, StackMapTable）"

  exception_entry:
    - name: start_pc
      type: uint16
      description: "例外ハンドラ範囲の開始位置（含む）"
    - name: end_pc
      type: uint16
      description: "例外ハンドラ範囲の終了位置（含まない）"
    - name: handler_pc
      type: uint16
      description: "例外ハンドラコードの開始位置"
    - name: catch_type
      type: uint16
      description: "例外クラスのコンスタントプールインデックス（0 = 全捕捉）"

  constantvalue_attribute_body:
    - name: constantvalue_index
      type: uint16
      description: "定数値のコンスタントプールインデックス（CONSTANT_Long, CONSTANT_Float, CONSTANT_Double, CONSTANT_Integer, CONSTANT_String）"

  exceptions_attribute_body:
    - name: number_of_exceptions
      type: uint16
    - name: exception_index_table
      type: uint16
      repeat_count: "{number_of_exceptions}"
      description: "例外クラスのコンスタントプールインデックス（CONSTANT_Class）"

  raw_data:
    - name: data
      type: bytes
      size: remaining
