name: FLAC
endianness: big
root: flac

enums:
  picture_type:
    - value: 0
      label: Other
    - value: 1
      label: File_Icon_32x32
    - value: 2
      label: Other_File_Icon
    - value: 3
      label: Front_Cover
    - value: 4
      label: Back_Cover
    - value: 5
      label: Leaflet
    - value: 6
      label: Media
    - value: 7
      label: Lead_Artist
    - value: 8
      label: Artist
    - value: 9
      label: Conductor
    - value: 10
      label: Band
    - value: 11
      label: Composer
    - value: 12
      label: Lyricist
    - value: 13
      label: Recording_Location
    - value: 14
      label: During_Recording
    - value: 15
      label: During_Performance
    - value: 16
      label: Movie_Screen_Capture
    - value: 17
      label: A_Bright_Coloured_Fish
    - value: 18
      label: Illustration
    - value: 19
      label: Band_Logotype
    - value: 20
      label: Publisher_Logotype

structs:
  flac:
    - name: magic
      type: bytes
      size: "4"
      expected: [0x66, 0x4C, 0x61, 0x43]
      description: "fLaCマジック"
    - name: metadata_blocks
      type: struct
      struct: metadata_block
      repeat_until: "{is_last == 1}"

  metadata_block:
    - name: header_byte
      type: uint8
    - name: is_last
      type: virtual
      value: "{header_byte >> 7}"
      description: "最終ブロックフラグ（1=最終）"
    - name: block_type
      type: virtual
      value: "{header_byte & 127}"
      description: "ブロックタイプ（0=STREAMINFO, 1=PADDING, 2=APPLICATION, 3=SEEKTABLE, 4=VORBIS_COMMENT, 5=CUESHEET, 6=PICTURE）"
    - name: length_b0
      type: uint8
    - name: length_b1
      type: uint8
    - name: length_b2
      type: uint8
    - name: length
      type: virtual
      value: "{(length_b0 << 16) | (length_b1 << 8) | length_b2}"
      description: "ブロックデータ長（24ビット）"
    - name: data
      type: switch
      size: "{length}"
      switch_on: "{block_type}"
      cases:
        "0": streaminfo
        "1": padding_block
        "2": application_block
        "3": seektable_block
        "4": vorbis_comment_block
        "5": cuesheet_block
        "6": picture_block
      default: raw_data

  streaminfo:
    - name: min_block_size
      type: uint16
      description: "最小ブロックサイズ（サンプル数）"
    - name: max_block_size
      type: uint16
      description: "最大ブロックサイズ（サンプル数）"
    - name: min_frame_size_b0
      type: uint8
    - name: min_frame_size_b1
      type: uint8
    - name: min_frame_size_b2
      type: uint8
    - name: min_frame_size
      type: virtual
      value: "{(min_frame_size_b0 << 16) | (min_frame_size_b1 << 8) | min_frame_size_b2}"
      description: "最小フレームサイズ（バイト、0=不明）"
    - name: max_frame_size_b0
      type: uint8
    - name: max_frame_size_b1
      type: uint8
    - name: max_frame_size_b2
      type: uint8
    - name: max_frame_size
      type: virtual
      value: "{(max_frame_size_b0 << 16) | (max_frame_size_b1 << 8) | max_frame_size_b2}"
      description: "最大フレームサイズ（バイト、0=不明）"
    - name: sample_rate_channels_bps_samples
      type: bitfield
      size: "8"
      fields:
        - name: sample_rate
          bits: "63:44"
          description: "サンプルレート（Hz）"
        - name: channels
          bits: "43:41"
          description: "チャンネル数 - 1（実値は+1）"
        - name: bps
          bits: "40:36"
          description: "ビット/サンプル - 1（実値は+1）"
        - name: total_samples
          bits: "35:0"
          description: "総サンプル数（0=不明）"
    - name: md5
      type: bytes
      size: "16"
      description: "非圧縮オーディオデータのMD5シグネチャ"

  padding_block:
    - name: padding
      type: bytes
      size: remaining

  application_block:
    - name: app_id
      type: bytes
      size: "4"
      description: "アプリケーションID"
    - name: data
      type: bytes
      size: remaining

  seektable_block:
    - name: seekpoints
      type: struct
      struct: seekpoint
      repeat: eof

  seekpoint:
    - name: sample_number
      type: uint64
      description: "ターゲットフレームの先頭サンプル番号"
    - name: offset
      type: uint64
      description: "先頭フレームヘッダからのオフセット（バイト）"
    - name: num_samples
      type: uint16
      description: "ターゲットフレームのサンプル数"

  vorbis_comment_block:
    endianness: little
    fields:
      - name: vendor_length
        type: uint32
        endianness: little
        description: "ベンダー文字列長"
      - name: vendor_string
        type: utf8
        size: "{vendor_length}"
        description: "ベンダー文字列"
      - name: comment_count
        type: uint32
        endianness: little
        description: "コメント数"
      - name: comments
        type: struct
        struct: vorbis_comment_entry
        repeat_count: "{comment_count}"

  vorbis_comment_entry:
    endianness: little
    fields:
      - name: length
        type: uint32
        endianness: little
        description: "コメント文字列長"
      - name: value
        type: utf8
        size: "{length}"
        description: "コメント文字列（KEY=VALUE形式）"

  cuesheet_block:
    - name: media_catalog
      type: ascii
      size: "128"
      description: "メディアカタログ番号"
    - name: lead_in_samples
      type: uint64
      description: "リードインサンプル数"
    - name: cuesheet_flags
      type: bitfield
      size: "1"
      fields:
        - name: is_cd
          bits: "7"
          description: "CDフラグ（1=コンパクトディスク）"
    - name: reserved
      type: bytes
      size: "258"
      description: "予約領域"
    - name: num_tracks
      type: uint8
      description: "トラック数"
    - name: tracks
      type: struct
      struct: cuesheet_track
      repeat_count: "{num_tracks}"

  cuesheet_track:
    - name: track_offset
      type: uint64
      description: "トラックオフセット（サンプル数）"
    - name: track_number
      type: uint8
      description: "トラック番号"
    - name: isrc
      type: ascii
      size: "12"
      description: "トラックISRC"
    - name: track_flags
      type: bitfield
      size: "1"
      fields:
        - name: track_type
          bits: "7"
          description: "トラックタイプ（0=オーディオ、1=非オーディオ）"
        - name: pre_emphasis
          bits: "6"
          description: "プリエンファシス（0=なし、1=あり）"
    - name: track_reserved
      type: bytes
      size: "13"
      description: "予約領域"
    - name: num_indices
      type: uint8
      description: "インデックスポイント数"
    - name: indices
      type: struct
      struct: cuesheet_index
      repeat_count: "{num_indices}"

  cuesheet_index:
    - name: offset
      type: uint64
      description: "トラック先頭からのサンプルオフセット"
    - name: index_number
      type: uint8
      description: "インデックスポイント番号"
    - name: reserved
      type: bytes
      size: "3"
      padding: true
      description: "予約領域"

  picture_block:
    - name: picture_type
      type: uint32
      enum: picture_type
    - name: mime_length
      type: uint32
    - name: mime
      type: ascii
      size: "{mime_length}"
      description: "MIMEタイプ"
    - name: desc_length
      type: uint32
    - name: description
      type: utf8
      size: "{desc_length}"
      description: "画像の説明"
    - name: width
      type: uint32
    - name: height
      type: uint32
    - name: depth
      type: uint32
      description: "ビット深度"
    - name: colors
      type: uint32
      description: "インデックスカラー数（0=非インデックス）"
    - name: data_length
      type: uint32
    - name: data
      type: bytes
      size: "{data_length}"
      description: "画像データ"

  raw_data:
    - name: data
      type: bytes
      size: remaining
