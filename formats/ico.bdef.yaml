name: ICO
endianness: little
root: ico

enums:
  ico_type:
    - value: 1
      label: ICO
      description: "アイコン画像形式（.ico）"
    - value: 2
      label: CUR
      description: "カーソル画像形式（.cur）"

structs:
  ico:
    - name: reserved
      type: uint16
      expected: [0x00, 0x00]
    - name: type
      type: uint16
      enum: ico_type
      description: "1 = ICO（アイコン）、2 = CUR（カーソル）"
    - name: count
      type: uint16
      description: "ファイル内の画像数"
    - name: entries
      type: struct
      struct: ico_entry
      repeat_count: "{count}"

  ico_entry:
    - name: width
      type: uint8
      description: "幅（ピクセル、0は256を意味する）"
    - name: height
      type: uint8
      description: "高さ（ピクセル、0は256を意味する）"
    - name: color_count
      type: uint8
      description: "パレットの色数（256色以上の場合は0）"
    - name: reserved
      type: uint8
    - name: planes
      type: uint16
      description: "カラープレーン数（ICO）またはホットスポットX座標（CUR）"
    - name: bpp
      type: uint16
      description: "ビット/ピクセル（ICO）またはホットスポットY座標（CUR）"
    - name: bytes_in_res
      type: uint32
      description: "画像データのサイズ（バイト）"
    - name: image_offset
      type: uint32
      description: "ファイル先頭から画像データまでのオフセット"
    - name: image_magic
      type: uint32
      endianness: big
      seek: "{image_offset}"
      seek_restore: true
      description: "画像形式シグネチャ（0x89504E47 = PNG、それ以外はBMP DIBヘッダ）"
    - name: image_data
      type: switch
      seek: "{image_offset}"
      seek_restore: true
      size: "{bytes_in_res}"
      switch_on: "{image_magic}"
      cases:
        "0x89504E47": png_image_data
      default: bmp_dib_image_data

  png_image_data:
    - name: data
      type: bytes
      size: remaining
      description: "PNG形式画像データ（PNGシグネチャ 89 50 4E 47 で開始）"

  bmp_dib_image_data:
    - name: data
      type: bytes
      size: remaining
      description: "BMP DIB形式画像データ（BMPファイルヘッダなしのBITMAPINFOHEADER）"
