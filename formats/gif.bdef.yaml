name: GIF
endianness: little
root: gif

enums:
  block_introducer:
    - value: 0x2C
      label: Image
    - value: 0x21
      label: Extension
    - value: 0x3B
      label: Trailer

  extension_label:
    - value: 0xF9
      label: Graphic_Control
    - value: 0xFE
      label: Comment
    - value: 0xFF
      label: Application
    - value: 0x01
      label: Plain_Text

  disposal_method:
    - value: 0
      label: None
    - value: 1
      label: Do_Not_Dispose
    - value: 2
      label: Restore_to_Background
    - value: 3
      label: Restore_to_Previous

structs:
  gif:
    - name: signature
      type: ascii
      size: "3"
      expected: [0x47, 0x49, 0x46]
      description: "GIFシグネチャ（'GIF'）"
    - name: version
      type: ascii
      size: "3"
      description: "バージョン（'87a'または'89a'）"
    - name: logical_screen_desc
      type: struct
      struct: logical_screen_desc
    - name: global_color_table
      type: bytes
      size: "{3 * (1 << (size_of_global_color_table + 1))}"
      if: "{global_color_table_flag == 1}"
      description: "グローバルカラーテーブル（1エントリ3バイト）"
    - name: blocks
      type: struct
      struct: gif_block
      repeat: eof

  logical_screen_desc:
    - name: width
      type: uint16
    - name: height
      type: uint16
    - name: packed
      type: bitfield
      size: "1"
      fields:
        - name: global_color_table_flag
          bits: "7"
        - name: color_resolution
          bits: "6:4"
        - name: sort_flag
          bits: "3"
        - name: size_of_global_color_table
          bits: "2:0"
    - name: bg_color_index
      type: uint8
      description: "背景色インデックス"
    - name: pixel_aspect_ratio
      type: uint8

  gif_block:
    - name: introducer
      type: uint8
      enum: block_introducer
    - name: body
      type: switch
      switch_on: "{introducer}"
      cases:
        "0x3B": trailer
        "0x2C": image_block
        "0x21": extension_block
      default: raw_data

  trailer: []

  image_block:
    - name: left
      type: uint16
    - name: top
      type: uint16
    - name: width
      type: uint16
    - name: height
      type: uint16
    - name: packed
      type: bitfield
      size: "1"
      fields:
        - name: local_color_table_flag
          bits: "7"
        - name: interlace_flag
          bits: "6"
        - name: sort_flag
          bits: "5"
        - name: reserved
          bits: "4:3"
        - name: size_of_local_color_table
          bits: "2:0"
    - name: local_color_table
      type: bytes
      size: "{3 * (1 << (size_of_local_color_table + 1))}"
      if: "{local_color_table_flag == 1}"
      description: "ローカルカラーテーブル"
    - name: lzw_min_code_size
      type: uint8
      description: "LZW最小符号サイズ"
    - name: sub_block_data
      type: bytes
      size: remaining
      description: "LZW圧縮サブブロック（生データ）"

  extension_block:
    - name: label
      type: uint8
      enum: extension_label
    - name: body
      type: switch
      switch_on: "{label}"
      cases:
        "0xF9": graphic_control_ext
        "0xFE": comment_ext
        "0xFF": application_ext
        "0x01": plain_text_ext
      default: generic_ext

  graphic_control_ext:
    - name: block_size
      type: uint8
      description: "ブロックサイズ（常に4）"
    - name: packed
      type: bitfield
      size: "1"
      fields:
        - name: reserved
          bits: "7:5"
        - name: disposal_method
          bits: "4:2"
          enum: disposal_method
        - name: user_input_flag
          bits: "1"
        - name: transparent_color_flag
          bits: "0"
    - name: delay_time
      type: uint16
      description: "遅延時間（1/100秒単位）"
    - name: transparent_color_index
      type: uint8
    - name: terminator
      type: uint8
      description: "ブロックターミネータ（常に0x00）"

  comment_ext:
    - name: data
      type: bytes
      size: remaining
      description: "コメントサブブロック（生データ）"

  application_ext:
    - name: block_size
      type: uint8
      description: "ブロックサイズ（常に11）"
    - name: app_identifier
      type: ascii
      size: "8"
      description: "アプリケーション識別子"
    - name: auth_code
      type: bytes
      size: "3"
      description: "アプリケーション認証コード"
    - name: app_data
      type: switch
      switch_on: "{app_identifier}"
      cases:
        "'NETSCAPE'": netscape_ext_data
      default: generic_app_ext_data

  netscape_ext_data:
    - name: sub_block_size
      type: uint8
      description: "サブブロックサイズ（通常3）"
    - name: sub_block_id
      type: uint8
      description: "サブブロックID（通常1）"
    - name: loop_count
      type: uint16
      description: "ループ回数（0 = 無限ループ）"
    - name: terminator
      type: uint8
      description: "ブロックターミネータ（常に0x00）"

  generic_app_ext_data:
    - name: sub_block_data
      type: bytes
      size: remaining
      description: "アプリケーションサブブロックデータ（生データ）"

  plain_text_ext:
    - name: block_size
      type: uint8
      description: "ブロックサイズ（常に12）"
    - name: text_grid_left
      type: uint16
      description: "テキストグリッド左位置"
    - name: text_grid_top
      type: uint16
      description: "テキストグリッド上位置"
    - name: text_grid_width
      type: uint16
      description: "テキストグリッド幅"
    - name: text_grid_height
      type: uint16
      description: "テキストグリッド高さ"
    - name: cell_width
      type: uint8
      description: "文字セル幅"
    - name: cell_height
      type: uint8
      description: "文字セル高さ"
    - name: fg_color_index
      type: uint8
      description: "テキスト前景色インデックス"
    - name: bg_color_index
      type: uint8
      description: "テキスト背景色インデックス"
    - name: text_data
      type: bytes
      size: remaining
      description: "プレーンテキストデータサブブロック（生データ）"

  generic_ext:
    - name: data
      type: bytes
      size: remaining
      description: "拡張サブブロック（生データ）"

  raw_data:
    - name: data
      type: bytes
      size: remaining
