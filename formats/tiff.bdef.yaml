name: TIFF
root: tiff

enums:
  tiff_tag:
    - value: 254
      label: NewSubfileType
    - value: 256
      label: ImageWidth
    - value: 257
      label: ImageLength
    - value: 258
      label: BitsPerSample
    - value: 259
      label: Compression
    - value: 262
      label: PhotometricInterpretation
    - value: 270
      label: ImageDescription
    - value: 271
      label: Make
    - value: 272
      label: Model
    - value: 273
      label: StripOffsets
    - value: 274
      label: Orientation
    - value: 277
      label: SamplesPerPixel
    - value: 278
      label: RowsPerStrip
    - value: 279
      label: StripByteCounts
    - value: 282
      label: XResolution
    - value: 283
      label: YResolution
    - value: 284
      label: PlanarConfiguration
    - value: 296
      label: ResolutionUnit
    - value: 305
      label: Software
    - value: 306
      label: DateTime
    - value: 315
      label: Artist
    - value: 320
      label: ColorMap
    - value: 322
      label: TileWidth
    - value: 323
      label: TileLength
    - value: 324
      label: TileOffsets
    - value: 325
      label: TileByteCounts
    - value: 330
      label: SubIFDs
    - value: 513
      label: JPEGInterchangeFormat
    - value: 514
      label: JPEGInterchangeFormatLength
    - value: 529
      label: YCbCrCoefficients
    - value: 530
      label: YCbCrSubSampling
    - value: 531
      label: YCbCrPositioning
    - value: 532
      label: ReferenceBlackWhite
    - value: 34665
      label: ExifIFD
    - value: 34853
      label: GPSIFD

  tiff_field_type:
    - value: 1
      label: BYTE
    - value: 2
      label: ASCII
    - value: 3
      label: SHORT
    - value: 4
      label: LONG
    - value: 5
      label: RATIONAL
    - value: 6
      label: SBYTE
    - value: 7
      label: UNDEFINED
    - value: 8
      label: SSHORT
    - value: 9
      label: SLONG
    - value: 10
      label: SRATIONAL
    - value: 11
      label: FLOAT
    - value: 12
      label: DOUBLE

  tiff_compression:
    - value: 1
      label: Uncompressed
    - value: 2
      label: CCITT_1D
    - value: 3
      label: Group3_Fax
    - value: 4
      label: Group4_Fax
    - value: 5
      label: LZW
    - value: 6
      label: JPEG_old
    - value: 7
      label: JPEG_new
    - value: 8
      label: Deflate
    - value: 32773
      label: PackBits
    - value: 34661
      label: JBIG
    - value: 34712
      label: JPEG2000
    - value: 34892
      label: WebP

structs:
  tiff:
    - name: byte_order
      type: ascii
      size: "2"
      description: "バイトオーダーマーク（II=LE, MM=BE）"
      validate: "{byte_order == 'II' or byte_order == 'MM'}"
    - name: body
      type: struct
      struct: tiff_body

  tiff_body:
    endianness: "{byte_order == 'II' ? 'little' : 'big'}"
    fields:
      - name: magic
        type: uint16
        description: "TIFFマジックナンバー（42）"
        validate: "{magic == 42}"
      - name: ifd_offset
        type: uint32
        description: "最初のIFDへのオフセット"
      - name: ifd0
        type: struct
        struct: ifd
        seek: "{ifd_offset}"
        description: "最初のIFD"

  ifd:
    - name: entry_count
      type: uint16
      description: "ディレクトリエントリ数"
    - name: entries
      type: struct
      struct: ifd_entry
      repeat_count: "{entry_count}"
    - name: next_ifd_offset
      type: uint32
      description: "次のIFDへのオフセット（0の場合はなし）"

  ifd_entry:
    - name: tag
      type: uint16
      enum: tiff_tag
    - name: field_type
      type: uint16
      enum: tiff_field_type
      description: "フィールドタイプとバイトサイズ: BYTE=1, ASCII=1, SHORT=2, LONG=4, RATIONAL=8, SBYTE=1, UNDEFINED=1, SSHORT=2, SLONG=4, SRATIONAL=8, FLOAT=4, DOUBLE=8"
    - name: count
      type: uint32
      description: "値の数"
    - name: value_offset
      type: uint32
      description: "合計サイズ（type_size × count）が4バイト以下の場合は値そのもの、それ以外は値データへのオフセット"
    - name: is_inline
      type: virtual
      value: "{(field_type == 1 and count <= 4) or (field_type == 3 and count <= 2) or (field_type == 4 and count == 1) or (field_type == 6 and count <= 4) or (field_type == 8 and count <= 2) or (field_type == 9 and count == 1)}"
      description: "値がインラインかどうか（type_size * count <= 4）"
    - name: inline_short_value
      type: virtual
      value: "{value_offset & 0xFFFF}"
      if: "{field_type == 3 and count == 1}"
      description: "SHORT型のインライン値（リトルエンディアン下位16ビット）"
    - name: inline_long_value
      type: virtual
      value: "{value_offset}"
      if: "{field_type == 4 and count == 1}"
      description: "LONG型のインライン値"
    - name: rational_value
      type: struct
      struct: rational_data
      seek: "{value_offset}"
      seek_restore: true
      if: "{field_type == 5 and count == 1}"
      description: "RATIONAL型の外部値（numerator/denominator）"
    - name: srational_value
      type: struct
      struct: srational_data
      seek: "{value_offset}"
      seek_restore: true
      if: "{field_type == 10 and count == 1}"
      description: "SRATIONAL型の外部値（signed numerator/denominator）"

  rational_data:
    - name: numerator
      type: uint32
      description: "分子"
    - name: denominator
      type: uint32
      description: "分母"

  srational_data:
    - name: numerator
      type: int32
      description: "分子（符号付き）"
    - name: denominator
      type: int32
      description: "分母（符号付き）"
