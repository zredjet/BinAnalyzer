name: AVI
endianness: little
root: avi

structs:
  avi:
    - name: magic
      type: ascii
      size: "4"
      expected: [0x52, 0x49, 0x46, 0x46]
      description: "RIFF"
    - name: file_size
      type: uint32
      description: "ファイルサイズ - 8バイト（RIFFヘッダ分）"
    - name: form_type
      type: ascii
      size: "4"
      expected: [0x41, 0x56, 0x49, 0x20]
      description: "AVIフォームタイプ（'AVI '）"
    - name: chunks
      type: struct
      struct: riff_chunk
      repeat: eof

  riff_chunk:
    - name: chunk_id
      type: ascii
      size: "4"
    - name: chunk_size
      type: uint32
    - name: data
      type: switch
      size: "{chunk_size}"
      switch_on: "{chunk_id}"
      cases:
        "'LIST'": list_chunk
        "'avih'": main_avi_header
        "'strh'": stream_header
        "'strf'": stream_format
        "'idx1'": avi_old_index
      default: raw_data
    - name: padding
      type: bytes
      size: "{chunk_size % 2}"
      if: "{chunk_size % 2 != 0}"
      padding: true
      description: "2バイト境界アライメント用パディング"

  list_chunk:
    - name: list_type
      type: ascii
      size: "4"
      description: "リストタイプ識別子（hdrl, strl, movi等）"
    - name: sub_chunks
      type: struct
      struct: riff_chunk
      repeat: eof

  main_avi_header:
    - name: dwMicroSecPerFrame
      type: uint32
      description: "フレーム表示間隔（マイクロ秒）"
    - name: dwMaxBytesPerSec
      type: uint32
      description: "最大データレート"
    - name: dwPaddingGranularity
      type: uint32
      description: "パディング粒度"
    - name: dwFlags
      type: uint32
      description: "AVIフラグ"
    - name: dwTotalFrames
      type: uint32
      description: "総フレーム数"
    - name: dwInitialFrames
      type: uint32
      description: "インターリーブファイルの初期フレーム数"
    - name: dwStreams
      type: uint32
      description: "ストリーム数"
    - name: dwSuggestedBufferSize
      type: uint32
      description: "推奨バッファサイズ"
    - name: dwWidth
      type: uint32
      description: "動画幅（ピクセル）"
    - name: dwHeight
      type: uint32
      description: "動画高さ（ピクセル）"
    - name: dwReserved
      type: bytes
      size: "16"
      description: "予約領域"

  stream_header:
    - name: fccType
      type: ascii
      size: "4"
      description: "ストリームタイプ（'vids'=映像, 'auds'=音声）"
    - name: fccHandler
      type: ascii
      size: "4"
      description: "コーデック識別子（FourCC）"
    - name: dwFlags
      type: uint32
    - name: wPriority
      type: uint16
    - name: wLanguage
      type: uint16
    - name: dwInitialFrames
      type: uint32
    - name: dwScale
      type: uint32
      description: "タイムスケール"
    - name: dwRate
      type: uint32
      description: "レート（fps = dwRate / dwScale）"
    - name: dwStart
      type: uint32
    - name: dwLength
      type: uint32
      description: "ストリーム長（dwScaleの単位）"
    - name: dwSuggestedBufferSize
      type: uint32
    - name: dwQuality
      type: uint32
    - name: dwSampleSize
      type: uint32
    - name: rcFrame
      type: bytes
      size: "8"
      description: "表示矩形（left, top, right, bottom 各 int16）"

  stream_format:
    - name: format_data
      type: switch
      size: remaining
      switch_on: "{fccType}"
      cases:
        "'vids'": bitmap_info_header
        "'auds'": wave_format_ex
      default: raw_data

  bitmap_info_header:
    - name: biSize
      type: uint32
      description: "構造体サイズ（バイト）"
    - name: biWidth
      type: int32
      description: "画像幅（ピクセル）"
    - name: biHeight
      type: int32
      description: "画像高さ（正=ボトムアップ、負=トップダウン）"
    - name: biPlanes
      type: uint16
      description: "プレーン数（常に1）"
    - name: biBitCount
      type: uint16
      description: "1ピクセルあたりのビット数"
    - name: biCompression
      type: ascii
      size: "4"
      description: "圧縮方式（FourCC）"
    - name: biSizeImage
      type: uint32
      description: "画像データサイズ（バイト）"
    - name: biXPelsPerMeter
      type: int32
      description: "水平解像度（ピクセル/メートル）"
    - name: biYPelsPerMeter
      type: int32
      description: "垂直解像度（ピクセル/メートル）"
    - name: biClrUsed
      type: uint32
      description: "使用色数"
    - name: biClrImportant
      type: uint32
      description: "重要色数"
    - name: extra
      type: bytes
      size: remaining
      if: "{remaining > 0}"
      description: "追加ヘッダデータ"

  wave_format_ex:
    - name: wFormatTag
      type: uint16
      description: "オーディオフォーマットタグ（1=PCM）"
    - name: nChannels
      type: uint16
      description: "チャンネル数"
    - name: nSamplesPerSec
      type: uint32
      description: "サンプリングレート（Hz）"
    - name: nAvgBytesPerSec
      type: uint32
      description: "平均バイトレート"
    - name: nBlockAlign
      type: uint16
      description: "ブロックアライメント（バイト）"
    - name: wBitsPerSample
      type: uint16
      description: "1サンプルあたりのビット数"
    - name: extra
      type: bytes
      size: remaining
      if: "{remaining > 0}"
      description: "拡張データ（cbSize + フォーマット固有データ）"

  avi_old_index:
    - name: entries
      type: struct
      struct: avi_index_entry
      repeat: eof

  avi_index_entry:
    - name: dwChunkId
      type: ascii
      size: "4"
      description: "チャンクID（'00dc'=映像, '01wb'=音声等）"
    - name: dwFlags
      type: uint32
      description: "フラグ（0x10=AVIIF_KEYFRAME）"
    - name: dwOffset
      type: uint32
      description: "moviリスト先頭からのオフセット"
    - name: dwSize
      type: uint32
      description: "チャンクデータサイズ"

  raw_data:
    - name: data
      type: bytes
      size: remaining
