name: MIDI
endianness: big
root: midi

enums:
  midi_format:
    - value: 0
      label: single_track
      description: "シングルトラック"
    - value: 1
      label: multi_track_sync
      description: "マルチトラック（同期）"
    - value: 2
      label: multi_track_async
      description: "マルチトラック（独立）"

structs:
  midi:
    - name: header_magic
      type: bytes
      size: "4"
      expected: [0x4D, 0x54, 0x68, 0x64]
      description: "MThd"
    - name: header_length
      type: uint32
      description: "ヘッダデータ長（常に6）"
      validate: "{header_length == 6}"
    - name: format
      type: uint16
      enum: midi_format
    - name: ntrks
      type: uint16
      description: "トラック数"
    - name: division
      type: uint16
      description: "4分音符あたりのティック数（PPQN）またはSMPTEタイミング。ビット15がタイミングモードを選択: 0=PPQN（4分音符あたりのティック数）、1=SMPTE。PPQNモードではビット14:0が4分音符あたりのティック数を表す"
    - name: timing_mode
      type: virtual
      value: "{division >> 15}"
      description: "タイミングモード（0=PPQN 4分音符あたりのティック数、1=SMPTE）"
    - name: ticks_per_quarter_note
      type: virtual
      value: "{division & 32767}"
      description: "PPQNモード: 4分音符あたりのティック数。SMPTEモード: ビット14:0にフレームレートとフレームあたりのティック数がエンコードされる"
    - name: tracks
      type: struct
      struct: mtrk
      repeat_count: "{ntrks}"

  mtrk:
    - name: magic
      type: bytes
      size: "4"
      expected: [0x4D, 0x54, 0x72, 0x6B]
      description: "MTrk"
    - name: length
      type: uint32
    - name: track_data
      type: switch
      size: "{length}"
      switch_on: "1"
      cases:
        "1": midi_event_list

  midi_event_list:
    - name: events
      type: struct
      struct: midi_event
      repeat: eof

  midi_event:
    - name: delta_time
      type: vlq
      description: "デルタタイム（VLQエンコード）"
    - name: status
      type: uint8
      description: "ステータスバイト"
    - name: event_data
      type: switch
      switch_on: "{status >> 4}"
      cases:
        "8": two_param_event
        "9": two_param_event
        "10": two_param_event
        "11": two_param_event
        "12": one_param_event
        "13": one_param_event
        "14": two_param_event
        "15": system_event_data
      default: raw_event_data

  two_param_event:
    - name: param1
      type: uint8
    - name: param2
      type: uint8

  one_param_event:
    - name: param1
      type: uint8

  system_event_data:
    - name: system_body
      type: switch
      switch_on: "{status}"
      cases:
        "255": meta_event_body
        "240": sysex_event_body
        "247": sysex_event_body
      default: raw_event_data

  meta_event_body:
    - name: meta_type
      type: uint8
      description: "メタイベントタイプ（0x2F=End of Track, 0x51=テンポ, 0x58=拍子記号）"
    - name: meta_length
      type: vlq
    - name: meta_data
      type: bytes
      size: "{meta_length}"

  sysex_event_body:
    - name: sysex_length
      type: vlq
    - name: sysex_data
      type: bytes
      size: "{sysex_length}"

  raw_event_data:
    - name: data
      type: bytes
      size: remaining

  raw_data:
    - name: data
      type: bytes
      size: remaining
