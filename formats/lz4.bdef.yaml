name: LZ4
endianness: little
root: lz4

enums:
  block_max_size:
    - value: 4
      label: 64KB
    - value: 5
      label: 256KB
    - value: 6
      label: 1MB
    - value: 7
      label: 4MB

structs:
  lz4:
    - name: magic
      type: uint32
      validate: "{magic == 0x184D2204}"
      description: "LZ4フレームマジックナンバー（0x184D2204）"
    - name: flg
      type: bitfield
      size: "1"
      fields:
        - name: dict_id
          bits: "0"
          description: "辞書IDフィールド有無"
        - name: reserved
          bits: "1"
        - name: content_checksum
          bits: "2"
          description: "コンテンツチェックサムフラグ"
        - name: content_size
          bits: "3"
          description: "コンテンツサイズフィールド有無"
        - name: b_checksum
          bits: "4"
          description: "ブロックチェックサムフラグ"
        - name: b_independence
          bits: "5"
          description: "ブロック独立フラグ"
        - name: version
          bits: "7:6"
          description: "バージョン（常に01）"
    - name: bd
      type: bitfield
      size: "1"
      fields:
        - name: reserved_bd
          bits: "3:0"
        - name: block_max_size
          bits: "6:4"
          enum: block_max_size
          description: "最大ブロックサイズ"
        - name: reserved_bd_high
          bits: "7"
    - name: content_size_value
      type: uint64
      if: "{content_size == 1}"
      description: "元データの非圧縮サイズ"
    - name: dict_id_value
      type: uint32
      if: "{dict_id == 1}"
      description: "辞書ID"
    - name: header_checksum
      type: uint8
      description: "ヘッダチェックサム（xxHash-32の第2バイト）"
    - name: blocks
      type: struct
      struct: lz4_data_block
      repeat_until: "{block_size_raw == 0}"
      description: "データブロック列（block_size=0のEndMarkで終了）"
    - name: content_checksum_value
      type: uint32
      if: "{content_checksum == 1}"
      description: "コンテンツチェックサム（xxHash-32）"

  lz4_data_block:
    - name: block_size_raw
      type: uint32
      description: "ブロックサイズ（最上位ビットは非圧縮フラグ、0=EndMark）"
    - name: block_data
      type: bytes
      size: "{block_size_raw & 0x7FFFFFFF}"
      if: "{block_size_raw != 0}"
      description: "ブロックデータ（圧縮または非圧縮）"
