name: SQLite
endianness: big
root: sqlite

enums:
  text_encoding:
    - value: 1
      label: UTF-8
    - value: 2
      label: UTF-16le
    - value: 3
      label: UTF-16be

  btree_page_type:
    - value: 2
      label: INDEX_INTERIOR
      description: "Interior index b-tree page"
    - value: 5
      label: TABLE_INTERIOR
      description: "Interior table b-tree page"
    - value: 10
      label: INDEX_LEAF
      description: "Leaf index b-tree page"
    - value: 13
      label: TABLE_LEAF
      description: "Leaf table b-tree page"

structs:
  sqlite:
    - name: header
      type: struct
      struct: database_header
    - name: first_page
      type: struct
      struct: btree_page_header

  database_header:
    - name: magic
      type: ascii
      size: "16"
      description: "Header string: 'SQLite format 3\\000'"
    - name: page_size
      type: uint16
      description: "Database page size in bytes (512-65536, or 1 for 65536)"
    - name: write_version
      type: uint8
      description: "File format write version (1=legacy, 2=WAL)"
    - name: read_version
      type: uint8
      description: "File format read version (1=legacy, 2=WAL)"
    - name: reserved_space
      type: uint8
      description: "Bytes of unused space at end of each page"
    - name: max_embedded_payload_fraction
      type: uint8
      description: "Must be 64"
    - name: min_embedded_payload_fraction
      type: uint8
      description: "Must be 32"
    - name: leaf_payload_fraction
      type: uint8
      description: "Must be 32"
    - name: file_change_counter
      type: uint32
    - name: database_size_pages
      type: uint32
      description: "Size of database in pages"
    - name: first_freelist_trunk_page
      type: uint32
    - name: total_freelist_pages
      type: uint32
    - name: schema_cookie
      type: uint32
    - name: schema_format_number
      type: uint32
      description: "1, 2, 3, or 4"
    - name: default_page_cache_size
      type: uint32
    - name: largest_root_btree_page
      type: uint32
      description: "Largest root b-tree page number (auto-vacuum/incremental-vacuum mode)"
    - name: text_encoding
      type: uint32
      enum: text_encoding
    - name: user_version
      type: uint32
    - name: incremental_vacuum_mode
      type: uint32
      description: "Non-zero for incremental-vacuum mode"
    - name: application_id
      type: uint32
    - name: reserved_for_expansion
      type: bytes
      size: "20"
    - name: version_valid_for
      type: uint32
    - name: sqlite_version_number
      type: uint32
      description: "e.g. 3039004 for 3.39.4"

  btree_page_header:
    - name: page_type
      type: uint8
      enum: btree_page_type
    - name: first_freeblock
      type: uint16
    - name: number_of_cells
      type: uint16
    - name: cell_content_offset
      type: uint16
      description: "Offset to first byte of cell content area (0 means 65536)"
    - name: fragmented_free_bytes
      type: uint8
    - name: right_most_pointer
      type: uint32
      if: "{page_type == 2 or page_type == 5}"
      description: "Right-most pointer (interior pages only)"
