name: Mach-O
endianness: little
root: macho

enums:
  cpu_type:
    - value: 7
      label: CPU_TYPE_X86
    - value: 12
      label: CPU_TYPE_ARM
    - value: 18
      label: CPU_TYPE_POWERPC
    - value: 16777223
      label: CPU_TYPE_X86_64
      description: "x86-64 (0x01000007)"
    - value: 16777228
      label: CPU_TYPE_ARM64
      description: "ARM64 (0x0100000C)"
    - value: 16777234
      label: CPU_TYPE_POWERPC64
      description: "PowerPC64 (0x01000012)"

  file_type:
    - value: 1
      label: MH_OBJECT
      description: "リロケータブルオブジェクト"
    - value: 2
      label: MH_EXECUTE
      description: "実行ファイル"
    - value: 3
      label: MH_FVMLIB
      description: "固定VM共有ライブラリ"
    - value: 4
      label: MH_CORE
      description: "コアダンプ"
    - value: 5
      label: MH_PRELOAD
    - value: 6
      label: MH_DYLIB
      description: "ダイナミックライブラリ"
    - value: 7
      label: MH_DYLINKER
      description: "ダイナミックリンカ"
    - value: 8
      label: MH_BUNDLE
      description: "バンドル"
    - value: 10
      label: MH_DSYM
      description: "デバッグシンボル"
    - value: 11
      label: MH_KEXT_BUNDLE
      description: "カーネル拡張バンドル"
    - value: 12
      label: MH_FILESET
      description: "ファイルセット"

  lc_type:
    - value: 1
      label: LC_SEGMENT
    - value: 2
      label: LC_SYMTAB
    - value: 4
      label: LC_THREAD
    - value: 5
      label: LC_UNIXTHREAD
    - value: 11
      label: LC_DYSYMTAB
    - value: 12
      label: LC_LOAD_DYLIB
    - value: 13
      label: LC_ID_DYLIB
    - value: 14
      label: LC_LOAD_DYLINKER
    - value: 25
      label: LC_SEGMENT_64
      description: "64ビットセグメント"
    - value: 27
      label: LC_UUID
    - value: 29
      label: LC_CODE_SIGNATURE
    - value: 30
      label: LC_SEGMENT_SPLIT_INFO
    - value: 34
      label: LC_SOURCE_VERSION
    - value: 36
      label: LC_VERSION_MIN_MACOSX
    - value: 38
      label: LC_FUNCTION_STARTS
    - value: 44
      label: LC_BUILD_VERSION
    - value: 2147483676
      label: LC_RPATH
      description: "ランパス検索パス（0x8000001C）"
    - value: 2147483682
      label: LC_DYLD_INFO_ONLY
      description: "Dyld情報（0x80000022）"
    - value: 2147483688
      label: LC_MAIN
      description: "エントリポイント（0x80000028）"
    - value: 2147483699
      label: LC_DYLD_EXPORTS_TRIE
      description: "Dyldエクスポートトライ（0x80000033）"
    - value: 2147483700
      label: LC_DYLD_CHAINED_FIXUPS
      description: "Dyldチェインフィクスアップ（0x80000034）"

  platform:
    - value: 1
      label: MACOS
    - value: 2
      label: IOS
    - value: 3
      label: TVOS
    - value: 4
      label: WATCHOS
    - value: 5
      label: BRIDGEOS
    - value: 6
      label: MACCATALYST
    - value: 7
      label: IOSSIMULATOR

flags:
  mh_flags:
    bit_size: 32
    fields:
      - name: MH_NOUNDEFS
        bit: 0
      - name: MH_DYLDLINK
        bit: 2
      - name: MH_TWOLEVEL
        bit: 7
      - name: MH_PIE
        bit: 21

structs:
  macho:
    - name: magic
      type: uint32
      description: "Mach-Oマジックナンバー"
    - name: body
      type: switch
      switch_on: "{magic}"
      cases:
        "0xFEEDFACE": mach_header_32_body
        "0xFEEDFACF": mach_header_64_body
      default: generic_body

  # 64ビットヘッダ本体（マジック以降）
  mach_header_64_body:
    - name: cputype
      type: uint32
      enum: cpu_type
    - name: cpusubtype
      type: uint32
    - name: filetype
      type: uint32
      enum: file_type
    - name: ncmds
      type: uint32
      description: "ロードコマンド数"
    - name: sizeofcmds
      type: uint32
      description: "ロードコマンドの合計サイズ"
    - name: flags
      type: uint32
      flags: mh_flags
    - name: reserved
      type: uint32
    - name: load_commands
      type: struct
      struct: load_command
      repeat_count: "{ncmds}"

  # 32ビットヘッダ本体（マジック以降）
  mach_header_32_body:
    - name: cputype
      type: uint32
      enum: cpu_type
    - name: cpusubtype
      type: uint32
    - name: filetype
      type: uint32
      enum: file_type
    - name: ncmds
      type: uint32
      description: "ロードコマンド数"
    - name: sizeofcmds
      type: uint32
      description: "ロードコマンドの合計サイズ"
    - name: flags
      type: uint32
      flags: mh_flags
    - name: load_commands
      type: struct
      struct: load_command
      repeat_count: "{ncmds}"

  load_command:
    endianness: little
    fields:
      - name: cmd
        type: uint32
        enum: lc_type
      - name: cmdsize
        type: uint32
        description: "このロードコマンドの合計サイズ"
      - name: body
        type: switch
        switch_on: "{cmd}"
        size: "{cmdsize - 8}"
        cases:
          "1": segment_32_body
          "2": symtab_body
          "12": load_dylib_body
          "25": segment_64_body
          "27": uuid_body
          "44": build_version_body
          "0x80000028": main_body
        default: generic_body

  # LC_SEGMENT_64 (cmd=25)
  segment_64_body:
    - name: segname
      type: ascii
      size: "16"
    - name: vmaddr
      type: uint64
    - name: vmsize
      type: uint64
    - name: fileoff
      type: uint64
    - name: filesize
      type: uint64
    - name: maxprot
      type: uint32
    - name: initprot
      type: uint32
    - name: nsects
      type: uint32
    - name: flags
      type: uint32
    - name: sections
      type: struct
      struct: section_64
      repeat_count: "{nsects}"

  section_64:
    - name: sectname
      type: ascii
      size: "16"
    - name: segname
      type: ascii
      size: "16"
    - name: addr
      type: uint64
    - name: size
      type: uint64
    - name: offset
      type: uint32
    - name: align
      type: uint32
    - name: reloff
      type: uint32
    - name: nreloc
      type: uint32
    - name: flags
      type: uint32
    - name: reserved1
      type: uint32
    - name: reserved2
      type: uint32
    - name: reserved3
      type: uint32

  # LC_SEGMENT (cmd=1) - 32ビットセグメント
  segment_32_body:
    - name: segname
      type: ascii
      size: "16"
    - name: vmaddr
      type: uint32
    - name: vmsize
      type: uint32
    - name: fileoff
      type: uint32
    - name: filesize
      type: uint32
    - name: maxprot
      type: uint32
    - name: initprot
      type: uint32
    - name: nsects
      type: uint32
    - name: flags
      type: uint32
    - name: sections
      type: struct
      struct: section_32
      repeat_count: "{nsects}"

  section_32:
    - name: sectname
      type: ascii
      size: "16"
    - name: segname
      type: ascii
      size: "16"
    - name: addr
      type: uint32
    - name: size
      type: uint32
    - name: offset
      type: uint32
    - name: align
      type: uint32
    - name: reloff
      type: uint32
    - name: nreloc
      type: uint32
    - name: flags
      type: uint32
    - name: reserved1
      type: uint32
    - name: reserved2
      type: uint32

  # LC_SYMTAB (cmd=2)
  symtab_body:
    - name: symoff
      type: uint32
      description: "シンボルテーブルオフセット"
    - name: nsyms
      type: uint32
      description: "シンボル数"
    - name: stroff
      type: uint32
      description: "文字列テーブルオフセット"
    - name: strsize
      type: uint32
      description: "文字列テーブルサイズ"

  # LC_UUID (cmd=27)
  uuid_body:
    - name: uuid
      type: bytes
      size: "16"

  # LC_LOAD_DYLIB (cmd=12)
  load_dylib_body:
    - name: name_offset
      type: uint32
      description: "ライブラリ名文字列のオフセット"
    - name: timestamp
      type: uint32
    - name: current_version
      type: uint32
    - name: compat_version
      type: uint32
    - name: name
      type: ascii
      size: remaining
      description: "ライブラリ名"

  # LC_MAIN (cmd=0x80000028)
  main_body:
    - name: entryoff
      type: uint64
      description: "エントリポイントのファイルオフセット"
    - name: stacksize
      type: uint64

  # LC_BUILD_VERSION (cmd=44)
  build_version_body:
    - name: platform
      type: uint32
      enum: platform
    - name: minos
      type: uint32
      description: "最小OSバージョン"
    - name: sdk
      type: uint32
      description: "SDKバージョン"
    - name: ntools
      type: uint32
      description: "ビルドツール数"
    - name: tools
      type: struct
      struct: build_tool_entry
      repeat_count: "{ntools}"

  build_tool_entry:
    - name: tool
      type: uint32
      description: "ビルドツール種別（1=clang, 2=swift, 3=ld, 4=lld）"
    - name: version
      type: uint32
      description: "ツールバージョン（major.minor.patchをエンコード）"

  generic_body:
    - name: data
      type: bytes
      size: remaining
