{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/zredjet/BinAnalyzer/schemas/bdef.schema.json",
  "title": "BinAnalyzer Format Definition",
  "description": "BinAnalyzer のバイナリフォーマット定義ファイル (.bdef.yaml) のスキーマ",
  "type": "object",
  "required": ["name", "root", "structs"],
  "additionalProperties": false,
  "properties": {
    "name": {
      "type": "string",
      "description": "フォーマットの名前（例: \"PNG\", \"BMP\"）"
    },
    "endianness": {
      "type": "string",
      "enum": ["big", "little", "be", "le"],
      "description": "デフォルトのバイトオーダー。省略時は big。",
      "default": "big"
    },
    "root": {
      "type": "string",
      "description": "ルート構造体の名前。structs 内で定義されている名前を指定する。"
    },
    "imports": {
      "type": "array",
      "description": "外部 .bdef.yaml ファイルのインポート。structs/enums/flags を取り込む。",
      "items": {
        "$ref": "#/$defs/import"
      }
    },
    "enums": {
      "type": "object",
      "description": "列挙型の定義。整数値とラベルのマッピング。",
      "additionalProperties": {
        "type": "array",
        "description": "列挙型のエントリリスト",
        "items": {
          "$ref": "#/$defs/enumEntry"
        }
      }
    },
    "flags": {
      "type": "object",
      "description": "フラグ型の定義。ビットフラグの名前付き展開。",
      "additionalProperties": {
        "$ref": "#/$defs/flagsDefinition"
      }
    },
    "structs": {
      "type": "object",
      "description": "構造体の定義。キーが構造体名、値がフィールドの配列またはオブジェクト（endianness/align/fields）。",
      "additionalProperties": {
        "oneOf": [
          {
            "type": "array",
            "description": "構造体のフィールドリスト（旧形式）",
            "items": {
              "$ref": "#/$defs/field"
            }
          },
          {
            "$ref": "#/$defs/structDefinition"
          }
        ]
      }
    }
  },
  "$defs": {
    "import": {
      "type": "object",
      "description": "インポート定義",
      "required": ["path"],
      "additionalProperties": false,
      "properties": {
        "path": {
          "type": "string",
          "description": "インポートする .bdef.yaml ファイルへの相対パス"
        }
      }
    },
    "enumEntry": {
      "type": "object",
      "description": "列挙型の1エントリ（整数値とラベル）",
      "required": ["value", "label"],
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": "integer",
          "description": "列挙値（整数）"
        },
        "label": {
          "type": "string",
          "description": "列挙ラベル名"
        },
        "description": {
          "type": "string",
          "description": "列挙値の説明テキスト"
        }
      }
    },
    "flagsDefinition": {
      "type": "object",
      "description": "フラグ型の定義",
      "required": ["bit_size", "fields"],
      "additionalProperties": false,
      "properties": {
        "bit_size": {
          "type": "integer",
          "minimum": 1,
          "description": "フラグ全体のビット幅（例: 8, 16, 32）"
        },
        "fields": {
          "type": "array",
          "description": "フラグフィールドのリスト",
          "items": {
            "$ref": "#/$defs/flagField"
          }
        }
      }
    },
    "flagField": {
      "type": "object",
      "description": "フラグの1ビット（または複数ビット）フィールド",
      "required": ["name", "bit"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "フラグフィールドの名前"
        },
        "bit": {
          "type": "integer",
          "minimum": 0,
          "description": "ビット位置（0始まり、LSBが0）"
        },
        "bit_size": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "ビット幅。省略時は1。"
        },
        "set": {
          "type": "string",
          "description": "ビットが1の時に表示するラベル"
        },
        "clear": {
          "type": "string",
          "description": "ビットが0の時に表示するラベル"
        }
      }
    },
    "field": {
      "type": "object",
      "description": "構造体内のフィールド定義",
      "required": ["name", "type"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "フィールド名"
        },
        "type": {
          "type": "string",
          "description": "フィールドの型。整数型（uint8, u8 等）、文字列型（ascii, utf8 等）、複合型（struct, switch, bitfield）、圧縮型（zlib, deflate）。",
          "enum": [
            "uint8", "u8",
            "uint16", "u16",
            "uint32", "u32",
            "uint64", "u64",
            "int8", "i8",
            "int16", "i16",
            "int32", "i32",
            "int64", "i64",
            "float32", "f32",
            "float64", "f64",
            "bytes",
            "ascii", "utf8",
            "utf16le", "utf16-le",
            "utf16be", "utf16-be",
            "sjis", "shift_jis", "shift-jis",
            "latin1", "iso-8859-1",
            "asciiz", "utf8z",
            "struct", "switch", "bitfield",
            "zlib", "deflate",
            "virtual"
          ]
        },
        "size": {
          "type": ["string", "integer"],
          "description": "フィールドのバイトサイズ。固定値（\"4\"）、式（\"{length}\"）、\"remaining\"（現在のスコープ内の残りバイト数）、または組み込み関数（\"{until_marker(0xFF, 0xD9)}\"）。整数型・浮動小数点型は省略可。"
        },
        "enum": {
          "type": "string",
          "description": "参照する列挙型の名前。整数値をラベルに変換する。"
        },
        "flags": {
          "type": "string",
          "description": "参照するフラグ型の名前。整数値をビットフラグとして展開する。"
        },
        "struct": {
          "type": "string",
          "description": "参照する構造体の名前。type が struct のとき必須。"
        },
        "repeat": {
          "type": "string",
          "enum": ["eof", "while", "length_prefixed"],
          "description": "繰り返しモード。\"eof\" でスコープ末尾まで繰り返す。\"while\" で条件が真の間繰り返す。\"length_prefixed\" で長さプレフィックス付きサブブロックを繰り返す。"
        },
        "length_prefix_size": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4,
          "default": 1,
          "description": "repeat: length_prefixed 時のプレフィックスのバイト数。省略時は1。"
        },
        "repeat_count": {
          "type": "string",
          "description": "繰り返し回数を指定する式（例: \"{num_entries}\"）"
        },
        "repeat_until": {
          "type": "string",
          "description": "繰り返し終了条件の式。式が真になるまで繰り返す。"
        },
        "repeat_while": {
          "type": "string",
          "description": "繰り返し継続条件の式。式が真の間、要素のデコード前に評価して繰り返す。"
        },
        "element_size": {
          "type": ["string", "integer"],
          "description": "繰り返しフィールドの各要素のバイトサイズ。固定値（\"40\"）または式（\"{entry_size}\"）。要素デコード後、未読バイトは自動スキップされる。"
        },
        "switch_on": {
          "type": "string",
          "description": "分岐条件の式。type が switch のとき必須。式の評価結果で cases を選択する。"
        },
        "cases": {
          "type": "object",
          "description": "switch の分岐先マップ。キーが条件値（整数/文字列リテラル）、値が構造体名。",
          "additionalProperties": {
            "type": "string"
          }
        },
        "default": {
          "type": "string",
          "description": "switch で cases にマッチしない場合のデフォルト構造体名"
        },
        "fields": {
          "type": "array",
          "description": "ビットフィールドのエントリリスト。type が bitfield のとき使用。",
          "items": {
            "$ref": "#/$defs/bitfieldEntry"
          }
        },
        "if": {
          "type": "string",
          "description": "条件式。式が真の場合のみこのフィールドをデコードする。"
        },
        "checksum": {
          "$ref": "#/$defs/checksum",
          "description": "チェックサム検証の設定"
        },
        "expected": {
          "type": "array",
          "description": "期待されるバイト値のリスト。マジックナンバーやシグネチャの検証に使用。",
          "items": {
            "type": "integer",
            "minimum": 0,
            "maximum": 255
          }
        },
        "description": {
          "type": "string",
          "description": "フィールドの説明テキスト。出力やエディタのホバーに表示される。"
        },
        "align": {
          "type": "integer",
          "minimum": 1,
          "description": "フィールドのアライメント（バイト単位）。デコード前に指定バウンダリまでスキップする。"
        },
        "padding": {
          "type": "boolean",
          "description": "true の場合、パディングフィールドとしてツリー出力で非表示にする。"
        },
        "value": {
          "type": "string",
          "description": "virtual型フィールドの値を計算する式。type が virtual のとき必須。"
        },
        "seek": {
          "type": "string",
          "description": "フィールドデコード前にジャンプする絶対オフセット（式）"
        },
        "seek_restore": {
          "type": "boolean",
          "description": "seekしたフィールドのデコード後に元の位置に復帰",
          "default": false
        },
        "endianness": {
          "type": "string",
          "enum": ["big", "little", "be", "le"],
          "description": "このフィールドに適用するエンディアン。構造体・フォーマットのデフォルトを上書きする。"
        },
        "validate": {
          "type": "string",
          "description": "デコード後に評価するバリデーション式。式が真なら ✓、偽なら ✗ を表示。"
        },
        "string_table": {
          "type": "string",
          "description": "参照する文字列テーブル名。整数値をオフセットとして文字列を解決する。"
        }
      }
    },
    "bitfieldEntry": {
      "type": "object",
      "description": "ビットフィールドの1エントリ",
      "required": ["name", "bits"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "ビットフィールドの名前"
        },
        "bits": {
          "type": "string",
          "description": "ビット位置。単一ビット（\"3\"）またはビット範囲（\"7:4\" = ビット7からビット4）。",
          "pattern": "^\\d+(:\\d+)?$"
        },
        "enum": {
          "type": "string",
          "description": "参照する列挙型の名前"
        },
        "description": {
          "type": "string",
          "description": "ビットフィールドの説明テキスト"
        }
      }
    },
    "checksum": {
      "type": "object",
      "description": "チェックサム検証の設定",
      "required": ["algorithm", "fields"],
      "additionalProperties": false,
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["crc32"],
          "description": "チェックサムアルゴリズム。現在は crc32 のみ対応。"
        },
        "fields": {
          "type": "array",
          "description": "チェックサムの計算対象となるフィールド名のリスト",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "structDefinition": {
      "type": "object",
      "description": "構造体定義（新形式）。endianness/align/fields を持つ。",
      "required": ["fields"],
      "additionalProperties": false,
      "properties": {
        "endianness": {
          "type": "string",
          "enum": ["big", "little", "be", "le"],
          "description": "この構造体内のフィールドに適用するエンディアン。フォーマットのデフォルトを上書きする。"
        },
        "align": {
          "type": "integer",
          "minimum": 1,
          "description": "繰り返し時の各要素のアライメント（バイト単位）"
        },
        "string_table": {
          "type": "boolean",
          "description": "trueの場合、この構造体のバイト列を文字列テーブルとして登録する。"
        },
        "fields": {
          "type": "array",
          "description": "構造体のフィールドリスト",
          "items": {
            "$ref": "#/$defs/field"
          }
        }
      }
    }
  }
}
