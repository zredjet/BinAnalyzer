# REQ-024: バイナリビジュアルマップ出力

## メタ情報

| 項目 | 値 |
|---|---|
| ステータス | approved |
| 優先度 | 低 |
| 依存 | なし |
| 作成日 | 2026-02-06 |
| 更新日 | 2026-02-06 |

## 背景・動機

バイナリファイル全体のどの範囲がどのフィールドに対応するかを視覚的に把握したい場合、ツリー出力やhexdumpでは全体像がつかみにくい。ファイル全体をブロック図として表示し、フィールドの占有範囲を視覚化することで、構造の理解が容易になる。

ユースケース:
- フォーマットの構造概要の把握
- パディングや未使用領域の発見
- フィールドサイズの比率の直感的な理解

## 機能要件

### 追加する機能

- [ ] `MapOutputFormatter` クラスの新規作成
  - ファイル全体をバー/ブロックとして表示
  - 各フィールドの範囲を色分けまたは記号で表示
  - フィールド名とオフセット/サイズの凡例
- [ ] 表示モード
  - テキストベース: ターミナル幅に合わせたアスキーアートブロック図
  - 各行がファイルの一定範囲（例: 16バイト/行）を表現
- [ ] CLIオプション
  - `--output map` または `-o map`

### 変更する既存機能

- [ ] Program.cs（CLI）: `--output map` の分岐追加

### 変更しないもの（スコープ外）

- GUI/グラフィカル出力（SVG, PNG画像等）
- インタラクティブ操作（ホバー、クリック等）
- ズーム機能

## 受入条件

1. [ ] `--output map` でビジュアルマップが出力されること
2. [ ] フィールド境界がオフセット付きで表示されること
3. [ ] 異なるフィールドが視覚的に区別できること
4. [ ] フィールド名の凡例が表示されること
5. [ ] ネストしたフィールドが適切に表現されること
6. [ ] 既存テストが全て通過すること

## 影響範囲

### 変更が必要なプロジェクト

| プロジェクト | 変更内容の概要 |
|---|---|
| BinAnalyzer.Core | 変更なし |
| BinAnalyzer.Dsl | 変更なし |
| BinAnalyzer.Engine | 変更なし |
| BinAnalyzer.Output | MapOutputFormatter の新規追加 |
| BinAnalyzer.Cli | `--output map` の追加 |

### 変更が必要なドキュメント

- [x] docs/dsl-reference.md — 変更不要
- [x] docs/architecture.md — 変更不要
- [x] CLAUDE.md — 変更不要
- [x] README.md — 変更不要

---

## 設計メモ

### 設計方針

`HexDumpOutputFormatter` の `CollectLeafFields` と同様にフィールド領域を収集し、ファイル全体のバイト範囲をブロック図として表示する。ターミナル幅（デフォルト80桁）に合わせたアスキーアート出力。

### 構成

```
src/BinAnalyzer.Output/
└── MapOutputFormatter.cs   # 新規
```

### 出力例

```
BinAnalyzer - Binary Map (67 bytes)
====================================================================
0x00000000 ┃████████┃ signature (8 bytes)
0x00000008 ┃████    ┃ chunks[0].length (4 bytes)
0x0000000C ┃████    ┃ chunks[0].type (4 bytes)
0x00000010 ┃█████████████┃ chunks[0].data (13 bytes)
0x0000001D ┃████    ┃ chunks[0].crc (4 bytes)
0x00000021 ┃████    ┃ chunks[1].length (4 bytes)
...
====================================================================
Legend: █ = 1 byte (scale: 1 char = 1 byte, max 64 chars)
```

### アルゴリズム

1. `CollectLeafFields` でリーフフィールドのリスト（offset, size, path）を収集
2. ファイルサイズに基づいてスケールファクターを決定（1バイト = 1文字、大きいファイルは縮小）
3. 各フィールドを1行で表示: オフセット + バー + フィールド名 + サイズ
4. バーの幅はフィールドサイズに比例（最小1文字、最大64文字）
5. 異なるフィールドは交互の文字（`█` / `░`）で区別

### バイトデータの必要性

`HexDumpOutputFormatter` と同様にバイトデータが必要（`ReadOnlyMemory<byte>`）。ただし内容は参照しない（サイズ情報のみ）ため、`IOutputFormatter` を実装しつつ追加メソッドも提供する構成とする。

### モデル変更

なし。

### インタフェース変更

なし。`HexDumpOutputFormatter` と同じパターンで独自メソッドを提供。

### 代替案

**案A: SVG画像として出力（不採用）**
- 理由: ターミナルで直接確認できることを優先。画像出力はHTML出力（REQ-020）の拡張として将来検討。

### 懸念事項

1. **大きなファイル**: 数千フィールドのファイルでは出力が非常に長くなる。`--depth N` オプションで表示深度を制限する機能を将来追加可能。

2. **スケーリング**: 大きなファイル（MB単位）ではバー幅の縮小が必要。対数スケールも検討可能だが、初期実装は線形スケールとする。

---

## 実装メモ

> 実装Phase（Phase 3-4）で記入する。

### 実装中の設計変更

### 追加したテスト

| テストクラス | テスト名 | 対応する受入条件 |
|---|---|---|
| | | |

### 気づき・今後の課題
