# REQ-049: SQLiteフォーマット定義

## メタ情報

| 項目 | 値 |
|---|---|
| ステータス | done |
| 優先度 | 中 |
| 依存 | REQ-044（オフセットジャンプ） |
| 作成日 | 2026-02-06 |
| 更新日 | 2026-02-06 |

## 背景・動機

SQLiteはファイルベースのリレーショナルデータベースで、モバイルアプリ、ブラウザ（IndexedDB）、組み込みシステム等で広く使用される。

100バイトのファイルヘッダにデータベースの基本情報（ページサイズ、テーブル数、エンコーディング等）が格納される。ページベースの構造でB-treeページをオフセットジャンプで読み取る。

フォレンジック分析、データ復旧、モバイルアプリ解析に有用。

## 機能要件

### 追加する機能

- [ ] `formats/sqlite.bdef.yaml` フォーマット定義
  - ファイルヘッダ（100バイト）
    - マジック文字列（"SQLite format 3\000"、16バイト）
    - ページサイズ（u16、512〜65536のべき乗）
    - ファイルフォーマットバージョン（読み取り/書き込み）
    - ページ数（in-header database size）
    - フリーリスト情報（先頭トランクページ、フリーリストページ数）
    - スキーマクッキー、スキーマフォーマット番号
    - デフォルトページキャッシュサイズ
    - テキストエンコーディング（enum: UTF-8, UTF-16le, UTF-16be）
    - ユーザーバージョン
    - バキュームモード
    - アプリケーションID
    - バージョン有効数
    - SQLiteバージョン番号
  - 第1ページのB-treeページヘッダ（seekでオフセット100にジャンプ）
    - フラグ（enum: interior index, interior table, leaf index, leaf table）
    - 最初のフリーブロック
    - セル数
    - セルコンテンツ開始位置
    - フラグメントバイト数

### 変更する既存機能

なし（YAMLファイルの追加のみ）。

### 変更しないもの（スコープ外）

- B-treeページの再帰走査
- セルコンテンツ（レコード）の解析
- WAL（Write-Ahead Logging）ファイルの解析
- ジャーナルファイルの解析
- 削除レコードの復旧
- VFS（Virtual File System）レイヤーの解析

## 受入条件

1. [ ] `formats/sqlite.bdef.yaml` が存在すること
2. [ ] ファイルヘッダの各フィールドが正しく解析できること
3. [ ] マジック文字列が正しく検証できること
4. [ ] テキストエンコーディングがenumラベル付きで表示されること
5. [ ] 第1ページのB-treeヘッダが解析できること
6. [ ] 有効なSQLiteファイルでデコードエラーにならないこと
7. [ ] フォーマット定義がバリデーションに通ること
8. [ ] 既存テストが全て通過すること

## 影響範囲

### 変更が必要なプロジェクト

| プロジェクト | 変更内容の概要 |
|---|---|
| BinAnalyzer.Core | 変更なし |
| BinAnalyzer.Dsl | 変更なし |
| BinAnalyzer.Engine | 変更なし |
| BinAnalyzer.Output | 変更なし |
| BinAnalyzer.Cli | 変更なし |

### 変更が必要なドキュメント

- [ ] README.md — 対応フォーマットにSQLiteを追記
- [ ] docs/architecture.md — formats/ ディレクトリに sqlite.bdef.yaml を追記

---

## 設計メモ

> 設計Phaseで記入する。

---

## 実装メモ

> 実装Phaseで記入する。

### 実装中の設計変更

### 追加したテスト

| テストクラス | テスト名 | 対応する受入条件 |
|---|---|---|
| | | |

### 気づき・今後の課題
